// Cross-broswer implementation of text ranges and selections / Text range utilities
// Combines bililiteRange.js, util.js, fancytext.js
// documentation: http://bililite.com/
// Copyright (c) 2013 Daniel Wachsstock
// MIT license http://www.opensource.org/licenses/mit-license.php/
!function(){function t(t){return"undefined"!=typeof t.value?"value":"undefined"!=typeof t.text?"text":"undefined"!=typeof t.textContent?"textContent":"innerText"}function e(){}function n(){}function i(t,e){var n=e.text.replace(/\r/g,"").length;if(t.compareEndPoints("StartToStart",e)<=0)return 0;if(t.compareEndPoints("StartToEnd",e)>=0)return n;for(var i=0;t.compareEndPoints("StartToStart",e)>0;++i,t.moveStart("character",-1));return i}function o(t,e){var n=e.text.replace(/\r/g,"").length;if(t.compareEndPoints("EndToEnd",e)>=0)return n;if(t.compareEndPoints("EndToStart",e)<=0)return 0;for(var i=0;t.compareEndPoints("EndToStart",e)>0;++i,t.moveEnd("character",-1));return i}function r(){}function s(){}function a(t,e){if(t.firstChild)return t.firstChild;if(t.nextSibling)return t.nextSibling;if(t===e)return null;for(;t.parentNode;){if(t=t.parentNode,t==e)return null;if(t.nextSibling)return t.nextSibling}return null}function l(t,e,n,i){if(!(0>=e)){var o=t[n?"startContainer":"endContainer"];for(3==o.nodeType&&(e+=t[n?"startOffset":"endOffset"]);o;){if(3==o.nodeType){var r=o.nodeValue.length;if(r>=e){if(t[n?"setStart":"setEnd"](o,e),e==r){for(var s=a(o,i);s&&3==s.nodeType&&0==s.nodeValue.length;s=a(s,i))t[n?"setStartAfter":"setEndAfter"](s);s&&1==s.nodeType&&"BR"==s.nodeName&&t[n?"setStartAfter":"setEndAfter"](s)}return}t[n?"setStartAfter":"setEndAfter"](o),e-=r}o=a(o,i)}}}function u(t,e){return t.compareBoundaryPoints(g,e)<=0?0:t.compareBoundaryPoints(_,e)>=0?e.toString().length:(t=t.cloneRange(),t.setEnd(e.endContainer,e.endOffset),e.toString().replace(/\r/g,"").length-t.toString().replace(/\r/g,"").length)}function c(t,e){return t.compareBoundaryPoints(b,e)>=0?e.toString().length:t.compareBoundaryPoints(v,e)<=0?0:(t=t.cloneRange(),t.setStart(e.startContainer,e.startOffset),t.toString().replace(/\r/g,"").length)}function d(){}var h="onfocusin"in document.createElement("input")?"focusin":"focus",p=document.createElement("div");p.appendChild(document.createTextNode("x-")),p.appendChild(document.createTextNode("x")),p.normalize();var f=3==p.firstChild.length;bililiteRange=function(e,i){function o(t){t&&9==t.which?a._nativeSelect(a._nativeRange(e.bililiteRangeSelection)):e.bililiteRangeSelection=a._nativeSelection()}var a;if(i)a=new d;else if(window.getSelection&&e.setSelectionRange)try{e.selectionStart,a=new r}catch(l){a=new d}else a=window.getSelection?new s:document.selection?new n:new d;if(a._el=e,a._doc=e.ownerDocument,a._win="defaultView"in a._doc?a._doc.defaultView:a._doc.parentWindow,a._textProp=t(e),a._bounds=[0,a.length()],!("bililiteRangeMouseDown"in a._doc)){var u={_el:a._doc};a._doc.bililiteRangeMouseDown=!1,bililiteRange.fn.listen.call(u,"mousedown",function(){a._doc.bililiteRangeMouseDown=!0}),bililiteRange.fn.listen.call(u,"mouseup",function(){a._doc.bililiteRangeMouseDown=!1})}if("bililiteRangeSelection"in e||(o(),"onbeforedeactivate"in e?a.listen("beforedeactivate",o):a.listen("mouseup",o).listen("keyup",o),a.listen(h,function(){a._doc.bililiteRangeMouseDown||a._nativeSelect(a._nativeRange(e.bililiteRangeSelection))})),!("oninput"in e)){var c=function(){a.dispatch({type:"input"})};a.listen("keyup",c),a.listen("cut",c),a.listen("paste",c),a.listen("drop",c),e.oninput="patched"}return a},e.prototype={length:function(){return this._el[this._textProp].replace(/\r/g,"").length},bounds:function(t){if(bililiteRange.bounds[t])this._bounds=bililiteRange.bounds[t].apply(this);else{if(!t){var e=[Math.max(0,Math.min(this.length(),this._bounds[0])),Math.max(0,Math.min(this.length(),this._bounds[1]))];return e[1]=Math.max(e[0],e[1]),e}this._bounds=t}return this},select:function(){var t=this._el.bililiteRangeSelection=this.bounds();return this._el==document.activeElement&&this._nativeSelect(this._nativeRange(t)),this.dispatch({type:"select"}),this},text:function(t,e){if(arguments.length){var n=this.bounds();this._el;return this.dispatch({type:"beforeinput",data:t,bounds:n}),this._nativeSetText(t,this._nativeRange(n)),"start"==e?this.bounds([n[0],n[0]]):"end"==e?this.bounds([n[0]+t.length,n[0]+t.length]):"all"==e&&this.bounds([n[0],n[0]+t.length]),this.dispatch({type:"input",data:t,bounds:n}),this}return this._nativeGetText(this._nativeRange(this.bounds())).replace(/\r/g,"")},insertEOL:function(){return this._nativeEOL(),this._bounds=[this._bounds[0]+1,this._bounds[0]+1],this},sendkeys:function(t){function e(t,e){/^{[^}]*}$/.test(e)&&(e=e.slice(1,-1));for(var n=0;n<e.length;++n){var i=e.charCodeAt(n);t.dispatch({type:"keypress",keyCode:i,which:i,charCode:i})}t.text(e,"end")}var n=this;return this.data().sendkeysOriginalText=this.text(),this.data().sendkeysBounds=void 0,t.replace(/{[^}]*}|[^{]+|{/g,function(t){(bililiteRange.sendkeys[t]||e)(n,t,e)}),this.bounds(this.data().sendkeysBounds),this.dispatch({type:"sendkeys",which:t}),this},top:function(){return this._nativeTop(this._nativeRange(this.bounds()))},scrollIntoView:function(t){var e=this.top();return(this._el.scrollTop>e||this._el.scrollTop+this._el.clientHeight<e)&&(t?t.call(this._el,e):this._el.scrollTop=e),this},wrap:function(t){return this._nativeWrap(t,this._nativeRange(this.bounds())),this},selection:function(t){return arguments.length?this.bounds("selection").text(t,"end").select():this.bounds("selection").text()},clone:function(){return bililiteRange(this._el).bounds(this.bounds())},all:function(t){return arguments.length?(this.dispatch({type:"beforeinput",data:t}),this._el[this._textProp]=t,this.dispatch({type:"input",data:t}),this):this._el[this._textProp].replace(/\r/g,"")},element:function(){return this._el},dispatch:function(t){t=t||{};var e=document.createEvent?document.createEvent("CustomEvent"):this._doc.createEventObject();e.initCustomEvent&&e.initCustomEvent(t.type,!!t.bubbles,!!t.cancelable,t.detail);for(var n in t)e[n]=t[n];var i=this._el;return setTimeout(function(){try{i.dispatchEvent?i.dispatchEvent(e):i.fireEvent("on"+t.type,document.createEventObject())}catch(n){var o=i["listen"+t.type];if(o)for(var r=0;r<o.length;++r)o[r].call(i,e)}},0),this},listen:function(t,e){var n=this._el;if(n.addEventListener)n.addEventListener(t,e);else{n.attachEvent("on"+t,e);var i=n["listen"+t]=n["listen"+t]||[];i.push(e)}return this},dontlisten:function(t,e){var n=this._el;if(n.removeEventListener)n.removeEventListener(t,e);else try{n.detachEvent("on"+t,e)}catch(i){var o=n["listen"+t];if(o)for(var r=0;r<o.length;++r)o[r]===e&&(o[r]=function(){})}return this}},bililiteRange.fn=e.prototype,bililiteRange.extend=function(t){for(fn in t)e.prototype[fn]=t[fn]},bililiteRange.bounds={all:function(){return[0,this.length()]},start:function(){return[0,0]},end:function(){return[this.length(),this.length()]},selection:function(){return this._el==document.activeElement?(this.bounds("all"),this._nativeSelection()):this._el.bililiteRangeSelection}},bililiteRange.sendkeys={"{enter}":function(t){var e="\n".charCodeAt(0);t.dispatch({type:"keypress",keyCode:e,which:e,charCode:e}),t.insertEOL()},"{tab}":function(t,e,n){n(t,"	")},"{newline}":function(t,e,n){n(t,"\n")},"{backspace}":function(t){var e=t.bounds();e[0]==e[1]&&t.bounds([e[0]-1,e[0]]),t.text("","end")},"{del}":function(t){var e=t.bounds();e[0]==e[1]&&t.bounds([e[0],e[0]+1]),t.text("","end")},"{rightarrow}":function(t){var e=t.bounds();e[0]==e[1]&&++e[1],t.bounds([e[1],e[1]])},"{leftarrow}":function(t){var e=t.bounds();e[0]==e[1]&&--e[0],t.bounds([e[0],e[0]])},"{selectall}":function(t){t.bounds("all")},"{selection}":function(t){for(var e=t.data().sendkeysOriginalText,n=0;n<e.length;++n){var i=e.charCodeAt(n);t.dispatch({type:"keypress",keyCode:i,which:i,charCode:i})}t.text(e,"end")},"{mark}":function(t){t.data().sendkeysBounds=t.bounds()}},bililiteRange.sendkeys["{Enter}"]=bililiteRange.sendkeys["{enter}"],bililiteRange.sendkeys["{Tab}"]=bililiteRange.sendkeys["{tab}"],bililiteRange.sendkeys["{Backspace}"]=bililiteRange.sendkeys["{backspace}"],bililiteRange.sendkeys["{Delete}"]=bililiteRange.sendkeys["{del}"],bililiteRange.sendkeys["{ArrowRight}"]=bililiteRange.sendkeys["{rightarrow}"],bililiteRange.sendkeys["{ArrowLeft}"]=bililiteRange.sendkeys["{leftarrow}"],n.prototype=new e,n.prototype._nativeRange=function(t){var e;return"INPUT"==this._el.tagName?e=this._el.createTextRange():(e=this._doc.body.createTextRange(),e.moveToElementText(this._el)),t&&(t[1]<0&&(t[1]=0),t[0]>this.length()&&(t[0]=this.length()),t[1]<e.text.replace(/\r/g,"").length&&(e.moveEnd("character",-1),e.moveEnd("character",t[1]-e.text.replace(/\r/g,"").length)),t[0]>0&&e.moveStart("character",t[0])),e},n.prototype._nativeSelect=function(t){t.select()},n.prototype._nativeSelection=function(){var t=this._nativeRange(),e=this.length(),n=this._doc.selection.createRange();try{return[i(n,t),o(n,t)]}catch(r){return n.parentElement().sourceIndex<this._el.sourceIndex?[0,0]:[e,e]}},n.prototype._nativeGetText=function(t){return t.text},n.prototype._nativeSetText=function(t,e){e.text=t},n.prototype._nativeEOL=function(){"value"in this._el?this.text("\n"):this._nativeRange(this.bounds()).pasteHTML("\n<br/>")},n.prototype._nativeTop=function(t){var e=this._nativeRange([0,0]);return t.boundingTop-e.boundingTop},n.prototype._nativeWrap=function(t,e){var n=document.createElement("div");n.appendChild(t);var i=n.innerHTML.replace("><",">"+e.htmlText+"<");e.pasteHTML(i)},r.prototype=new e,r.prototype._nativeRange=function(t){return t||[0,this.length()]},r.prototype._nativeSelect=function(t){this._el.setSelectionRange(t[0],t[1])},r.prototype._nativeSelection=function(){return[this._el.selectionStart,this._el.selectionEnd]},r.prototype._nativeGetText=function(t){return this._el.value.substring(t[0],t[1])},r.prototype._nativeSetText=function(t,e){var n=this._el.value;this._el.value=n.substring(0,e[0])+t+n.substring(e[1])},r.prototype._nativeEOL=function(){this.text("\n")},r.prototype._nativeTop=function(t){var e=this._el.cloneNode(!0);e.style.visibility="hidden",e.style.position="absolute",this._el.parentNode.insertBefore(e,this._el),e.style.height="1px",e.value=this._el.value.slice(0,t[0]);var n=e.scrollHeight;return e.value="X",n-=e.scrollHeight,e.parentNode.removeChild(e),n},r.prototype._nativeWrap=function(){throw new Error("Cannot wrap in a text element")},s.prototype=new e,s.prototype._nativeRange=function(t){var e=this._doc.createRange();return e.selectNodeContents(this._el),t&&(l(e,t[0],!0,this._el),e.collapse(!0),l(e,t[1]-t[0],!1,this._el)),e},s.prototype._nativeSelect=function(t){this._win.getSelection().removeAllRanges(),this._win.getSelection().addRange(t)},s.prototype._nativeSelection=function(){var t=this._nativeRange();if(0==this._win.getSelection().rangeCount)return[this.length(),this.length()];var e=this._win.getSelection().getRangeAt(0);return[u(e,t),c(e,t)]},s.prototype._nativeGetText=function(t){return String.prototype.slice.apply(this._el.textContent,this.bounds())},s.prototype._nativeSetText=function(t,e){e.deleteContents(),e.insertNode(this._doc.createTextNode(t)),f&&this._el.normalize()},s.prototype._nativeEOL=function(){var t=this._nativeRange(this.bounds());t.deleteContents();var e=this._doc.createElement("br");e.setAttribute("_moz_dirty",""),t.insertNode(e),t.insertNode(this._doc.createTextNode("\n")),t.collapse(!1)},s.prototype._nativeTop=function(t){if(0==this.length)return 0;if(""==t.toString()){var e=this._doc.createTextNode("X");t.insertNode(e)}var n=this._nativeRange([0,1]),i=t.getBoundingClientRect().top-n.getBoundingClientRect().top;return e&&e.parentNode.removeChild(e),i},s.prototype._nativeWrap=function(t,e){e.surroundContents(t)};var g=0,v=1,b=2,_=3;d.prototype=new e,d.prototype._nativeRange=function(t){return t||[0,this.length()]},d.prototype._nativeSelect=function(t){},d.prototype._nativeSelection=function(){return[0,0]},d.prototype._nativeGetText=function(t){return this._el[this._textProp].substring(t[0],t[1])},d.prototype._nativeSetText=function(t,e){var n=this._el[this._textProp];this._el[this._textProp]=n.substring(0,e[0])+t+n.substring(e[1])},d.prototype._nativeEOL=function(){this.text("\n")},d.prototype._nativeTop=function(){return 0},d.prototype._nativeWrap=function(){throw new Error("Wrapping not implemented")};var y=[];bililiteRange.fn.data=function(){var t=this.element().bililiteRangeData;return void 0==t&&(t=this.element().bililiteRangeData=y.length,y[t]=new m(this)),y[t]};try{Object.defineProperty({},"foo",{});var m=function(t){Object.defineProperty(this,"values",{value:{}}),Object.defineProperty(this,"sourceRange",{value:t}),Object.defineProperty(this,"toJSON",{value:function(){var t={};for(var e in m.prototype)e in this.values&&(t[e]=this.values[e]);return t}}),Object.defineProperty(this,"all",{get:function(){var t={};for(var e in m.prototype)t[e]=this[e];return t}})};m.prototype={},Object.defineProperty(m.prototype,"values",{value:{}}),Object.defineProperty(m.prototype,"monitored",{value:{}}),bililiteRange.data=function(t,e){e=e||{};var n=Object.getOwnPropertyDescriptor(m.prototype,t)||{};"enumerable"in e&&(n.enumerable=!!e.enumerable),"enumerable"in n||(n.enumerable=!0),"value"in e&&(m.prototype.values[t]=e.value),"monitored"in e&&(m.prototype.monitored[t]=e.monitored),n.configurable=!0,n.get=function(){return t in this.values?this.values[t]:m.prototype.values[t]},n.set=function(e){this.values[t]=e,m.prototype.monitored[t]&&this.sourceRange.dispatch({type:"bililiteRangeData",bubbles:!0,detail:{name:t,value:e}})},Object.defineProperty(m.prototype,t,n)}}catch(x){m=function(t){this.sourceRange=t},m.prototype={},bililiteRange.data=function(t,e){"value"in e&&(m.prototype[t]=e.value)}}}(),Array.prototype.forEach||(Array.prototype.forEach=function(t){"use strict";if(void 0===this||null===this)throw new TypeError;var e=Object(this),n=e.length>>>0;if("function"!=typeof t)throw new TypeError;for(var i=arguments.length>=2?arguments[1]:void 0,o=0;n>o;o++)o in e&&t.call(i,e[o],o,e)}),bililiteRange&&function(){function t(t){return new RegExp(t.source,"g"+(t.ignoreCase?"i":"")+(t.multiline?"m":""))}function e(t,e){return t&&t.index==e[0]&&t[0].length==e[1]-e[0]}function n(t,e){for(var n=t.length,i=e.length,o=0;i>o&&n>o&&e.charAt(o)==t.charAt(o);++o);var r=o;for(o=0;i>o&&n>o;++o){var s=i-o-1,a=n-o-1;if(r>s||r>a)break;if(e.charAt(s)!=t.charAt(a))break}var l=n-o,u=i-o;return{bounds:[r,l],data:e.slice(r,u)}}function i(t,e){return t.replace(/\n/g,"\n"+e)}function o(t,e,n){e=parseInt(e),(isNaN(e)||1>e)&&(e=4);var i=new RegExp((n?"(^)":"(\\n)")+"(	| {"+e+"})","g");return t.replace(i,"$1")}function r(t,e,n,i){for(var r=0;e>r;++r)t=o(t,n,i);return t}bililiteRange.bounds.EOL=function(){return this.bounds("startbounds"),this.findprimitive(/$/gm,this.bounds())?this.bounds():this.find(/$/m,!0).bounds()},bililiteRange.bounds.BOL=function(){return this.bounds("startbounds"),this.findprimitive(/^/gm,this.bounds())?this.bounds():this.findBack(/^/m,!0).bounds()},bililiteRange.bounds.line=function(){this.bounds("BOL");var t=this.bounds()[0];return this.bounds("EOL"),[t,this.bounds()[1]]},bililiteRange.bounds.startbounds=function(){return[this.bounds()[0],this.bounds()[0]]},bililiteRange.bounds.endbounds=function(){return[this.bounds()[1],this.bounds()[1]]};var s=bililiteRange.fn.text;bililiteRange.fn.text=function(t,e,n){return arguments.length?(n&&(t=i(t,this.indentation())),s.call(this,t,e)):s.call(this)},bililiteRange.extend({find:function(n,i,o){void 0!==n.nowrap&&(i=n.nowrap),n=t(n);var r=this.bounds();if(o)s="findprimitiveback",a=[0,r[0]-1];else var s="findprimitive",a=[r[0],Number.MAX_VALUE];var l=this[s](n,a);return e(l,r)&&(l=this[s](n,[r[0]+1,Number.MAX_VALUE])),l||i||(l=this[s](n,[0,Number.MAX_VALUE])),e(l,r)&&(l=!1),this.match=l,l&&this.bounds([l.index,l.index+l[0].length]),this},findBack:function(t,e){return this.find(t,e,!0)},indentation:function(){return/^\s*/.exec(this.clone().bounds("line").text())[0]},indent:function(t){var e=this.text(),n=i(e,t),o=this.bounds();return this.text(n),this.clone().bounds("BOL").text(t),this.bounds([o[0]+t.length,o[1]+t.length+n.length-e.length])},unindent:function(t,e){e=e||this.data().tabSize||8;var n=this.text(),i=r(n,t,e,!1),o=this.bounds();this.text(i).bounds([o[0],o[1]+i.length-n.length]);var s=this.clone().bounds("line");n=s.text(),i=r(n,t,e,!0),s.text(i);var a=i.length-n.length;return this.bounds([o[0]+a,o[1]+a])},line:function(t){if(arguments.length){if(t=parseInt(t),isNaN(t))return this;if(t>this.all().split("\n").length)return this.bounds("end");if(1>t)return this.bounds([0,0]);var e=this.bounds();this.bounds("BOL");var n=e[0]-this.bounds()[0],i=new RegExp("(.*\\n){"+(t-1)+"}(.{"+n+"}|.*$)","m");return this.bounds("all").find(i).bounds("endbounds")}return this.all().slice(0,this.bounds()[0]).split("\n").length},live:function(t){var e=this;if(0==arguments.length||t){if(this._oldtext=e.all(),this._inputHandler)return this;this._inputHandler=function(t){var i,o,r,s=e.all();if(s!=e._oldtext){if(!t.bounds){var a=n(e._oldtext,s);t.bounds=a.bounds,t.data=a.data}i=t.bounds[0],o=t.bounds[1],r=t.bounds[0]+t.data.length,e._oldtext=s,e._bounds[0]<=i||(e._bounds[0]>o?e._bounds[0]+=r-o:e._bounds[0]=r),e._bounds[1]<i||(e._bounds[1]>=o?e._bounds[1]+=r-o:e._bounds[1]=i)}},e.listen("input",e._inputHandler)}else e.dontlisten("input",e._inputHandler),delete e._inputHandler;return this},findprimitive:function(t,e){var n=this.all();t.lastIndex=e[0];var i=t.exec(n);return!i||i.index+i[0].length>e[1]?!1:i},findprimitiveback:function(t,e){var n=!1;do{var i=n;n=this.findprimitive(t,e),e[0]=n.index+1}while(n);return i}}),bililiteRange.diff=n}(),bililiteRange.fancyText=function(t,e,n){function i(t,e){if(!e)return t;var n;return function(){var i=this,o=arguments;clearTimeout(n),n=setTimeout(function(){t.apply(i,o)},e)}}function o(){r.bounds("selection"),/\n$/.test(t.textContent)||(t.textContent+="\n"),e(t),r.select()}var r=bililiteRange(t);return e&&(o(),r.listen("input",i(o,n))),r.listen("paste",function(t){r.bounds("selection").text(t.clipboardData.getData("text/plain").replace(/\r/g,""),"end").select(),t.preventDefault()}),r.listen("keydown",function(t){13==t.keyCode&&(r.bounds("selection").text("\n","end",r.data().autoindent).select(),t.preventDefault())}),t};var editor=document.querySelector("#source code");editor=bililiteRange.fancyText(editor,Prism.highlightElement),bililiteRange(editor).data().autoindent=!0;